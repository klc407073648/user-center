# 基于drogon实现用户中心后端


# 技术选型
   * 语言选择：c++
   * web框架选型：Drogon，Oat++   （https://github.com/search/advanced）
      * 搜索条件: ` C++ web framework stars:>1000 pushed:>2022-04-01 language:C++`

## drogon安装过程

* [wiki drogon](https://github.com/drogonframework/drogon/wiki/)
* [c++高性能web框架drogon入门教程一](https://blog.csdn.net/zh7314/article/details/115652164)
* [Github drogon](https://github.com/drogonframework/drogon)
* [Github jsoncpp](https://github.com/open-source-parsers/jsoncpp)
* [drogon-realworld](https://github.com/arslan2012/drogon-realworld-example-app)

### 依赖库

```
trantor，non-blocking I/O C++网络库，也是作者开发，已作为git仓库submodule，无需提前安装；
jsoncpp，json的c++库，版本不低于1.7；
libuuid，生成uuid的c库；
zlib，用于支持压缩传输；
OpenSSL，并非必须，如果安装了OpenSSL库，drogon将支持HTTPS，否则drogon只支持HTTP；
c-ares, 并非必须，如果安装了ares库，drogon对DNS的支持会具有更好的性能；
libbrotli，并非必须，如果安装了brotli库，drogon的HTTP响应会支持brotli压缩；
boost，版本不低于1.61，只在C++编译器不支持c++17时才需要安装；
postgreSQL, mariadb, sqlite3的客户端开发库，并非必须，安装后drogon会提供对响应的库的访问能力；
gtest, 并非必须，如果安装了gtest库，drogon的单元测试代码可以被编译；
```

jsoncpp
```
git clone https://github.com/open-source-parsers/jsoncpp
mkdir build && cd build && cmake .. && make && make install

安装后，使用下述语句解决 `drogon_ctl在创建的新项目的时候会找不到jsoncpp`

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib64   
export LIBRARY_PATH=$LIBRARY_PATH:/usr/local/lib64    
source /etc/profile
```
static Json::Value rep2json(BaseResponse<T> rep)
    {
        Json::Value ret;
        ret["code"] = rep.getCode();
		Json::Int64 tmstp = rep.getData();
        ret["data"] = tmstp;
        ret["message"] = rep.getMessage();
        ret["description"] = rep.getDescription();
        return ret;
    }
    

uuid
```
yum install -y libuuid-devel
```

OpenSSL
```
yum install -y openssl-devel
```

zlib
```
yum install -y zlib-devel
```

postgresql
```
yum install -y postgresql-devel
```

mysql
```
yum install -y mysql-devel mariadb-devel

报错
/home/drogon/drogon/orm_lib/src/mysql_impl/MysqlConnection.cc:59:5: error: ‘mysql_optionsv’ was not declared in this scope
     mysql_optionsv(mysqlPtr_.get(), MYSQL_OPT_RECONNECT, &reconnect_);

```

drogon

```
git clone https://github.com/drogonframework/drogon.git
cd drogon
git submodule update --init
mkdir build
cd build
cmake ..
make && sudo make install
```


postgresql
```
docker run -it -d --name postgresql -e POSTGRES_USER=postgres -e POSTGRES_DB=student -e POSTGRES_PASSWORD=456789 -p 5432:5432 -v /data/postgres_data:/var/lib/postgresql/data --privileged postgres

pg_hba.conf
# IPv4 local connections:
host    all        all        0.0.0.0/0        password
```

数据库测试

```
CREATE TABLE subjects
(
id int,
name varchar(255),
age int,
sex int,
address varchar(255)
)

INSERT INTO subjects	VALUES	(1,'dr3dwdwam',13,3,'Benling');
INSERT INTO subjects	VALUES	(2,'kkk',13,3,'Benling');
INSERT INTO subjects	VALUES	(3,'jjj',13,3,'Benling');
INSERT INTO subjects	VALUES	(4,'ggg',13,3,'Benling');

# 会根据数据库的内容创建出模型
drogon_ctl create model models=
```

创建工程的全过程:

```
# 创建工程
dg_ctl create project usercenter
# 控制器创建
cd ./usercenter/controllers/
dg_ctl create controller -h ControllerTest
# 过滤器创建
cd ../filters/
dg_ctl create filter LoginFilter
# 创建模型
cd ..
dg_ctl create model models
```

简单使用：

```
[root@iZuf61kbf845xt6tz10abgZ ~]# curl -XPOST 127.0.0.1:8082/api/user/UserService/register -H 'content-type: application/json' -d '{"userAccount":"111","userPassword":"222","checkPassword":"333","planetCode":"4444"}'
{"code":"200","data":"1","description":"ok","message":"ok"}

json解析
[root@iZuf61kbf845xt6tz10abgZ ~]# curl -XPOST 127.0.0.1:8082/api/user/UserService/register -H 'content-type:  application/json' -d '{"userAccount":"111","userPassword":"222","checkPassword":"333","planetCode":"4444"}'
{"code":200,"data":{"checkPassword":"333","planetCode":"4444","userAccount":"111","userPassword":"222"},"description":"ok","message":"ok","object":{"checkPassword":"333","planetCode":"4444","userAccount":"111","userPassword":"222"}}[
```

# 设计

1. 根据dg_ctl命令创建restful api
   * 控制器创建：`dg_ctl create controller -h api::user`
   * 测试：
      * 输入：
         ```
         curl -XPOST 127.0.0.1:8082/api/user/register -H 'content-type:  application/json' -d '{"userAccount":"111","userPassword":"222","checkPassword":"333","planetCode":"4444"}'
         ```
      * 输出：
         ```
         {"code":200,"data":{"checkPassword":"333","email":"","planetCode":"4444","userAccount":"111","userPassword":"222"},"description":"ok","message":"ok","object":{"checkPassword":"333","email":null,"planetCode":"4444","userAccount":"111","userPassword":"222"}}
         ```
   * 小步验证：前端与后端的 `/api/user/register`  接口交互是否正常

2. 设计类，封装类

   * common
      * BaseResponse
      * ErrorCode
      * ResultUtils
   * constant
      * UserConstant
   * controllers
      * api_user ————> UserController
   * exception
      * BusinessException
      * GlobalException
   * models
      * 考虑自动生成 表对应的内容
      * request
         * UserLoginRequest
         * UserRegisterRequest
   * services
      * impl
         * UserServiceImpl
      * service
         * UserService

* 不着急写，可以参考一下视频和 `drogon-realworld-example-app` 的内容

```
[root@VM-16-6-centos build]# ./usercenter
20220526 14:04:15.068979 UTC 23622 DEBUG [user] User constructor! - api_user.h:33
20220526 14:04:36.666588 UTC 23623 INFO  user::userRegister in - api_user.cc:13
20220526 14:04:36.666716 UTC 23623 INFO  11111 - api_user.cc:22
20220526 14:04:36.666738 UTC 23623 INFO  UserServiceImpl::userRegister in - UserServiceImpl.cc:9
20220526 14:05:17.827952 UTC 23623 INFO  user::userRegister in - api_user.cc:13
20220526 14:05:17.828002 UTC 23623 INFO  111 - api_user.cc:22
20220526 14:05:17.828015 UTC 23623 INFO  UserServiceImpl::userRegister in - UserServiceImpl.cc:9
20220526 14:05:17.828123 UTC 23623 INFO  BusinessException error - UserServiceImpl.cc:98
20220526 14:05:17.828127 UTC 23623 INFO  请求参数错误 - UserServiceImpl.cc:99

[root@VM-16-6-centos ~]# curl -XPOST 81.68.132.31:8082/api/user/register -H 'content-type:  application/json' -d '{"userAccount":"111","userPassword":"222","checkPassword":"333","planetCode":"4444"}'
{"code":200,"data":{"checkPassword":"333","email":"","planetCode":"4444","userAccount":"111","userPassword":"222"},"description":"ok","message":"ok","object":{"checkPassword":"333","email":null,"planetCode":"4444","userAccount":"111","userPassword":"222"}}[root@VM-16-6-centos ~]#

是不是返回的data = null 注册就会错？？？
```

学习使用navicat 转化mysql模型到postgresql
使用orm模型
```
[root@VM-16-6-centos test3]# drogon_ctl create model models
Create model
postgresql
Connect to server...
Source files in the models folder will be overwritten, continue(y/n)?
y
table name:user

创建后使用，getUseraccount 方法拿到的是指针，而不是值，还需学习一下
```


docker run -it -d -p 8082:8082 -v /home/klc/backend/drogon/:/home/ --name drogon_test docker.io/drogonframework/drogon /bin/bash


docker方式从0-1部署项目
```
# 下载安装docker和docker-compose
yum install -y docker
systemctl enable docker
systemctl start docker
curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version

# 将前端文件放置到 /home/klc/frontend/ 路径下，执行构建命令
cd /home/klc/frontend/
docker build -t user-center-frontend:v0.0.1 .
docker run -p 81:80 -d user-center-frontend:v0.0.1

# 将数据库文件放置到 /home/klc/mysql/ 路径下，执行构建命令
cd /home/klc/mysql/
 ./build_mysql.sh

# 将后端文件放置到 /home/klc/backend/drogon/ 路径下，执行构建命令
docker pull docker.io/drogonframework/drogon
docker run -it -d -p 8082:8082 -v /home/klc/backend/drogon/:/home/ --name drogon_test docker.io/drogonframework/drogon /bin/bash

docker exec -it drogon_test bash
cd /home/
cd ./build/
cmake ..
make
./usercenter
```

后续整理接口测试文件，测试功能



TDD：

```
测试场景：
异常测试：JSON Body不填会core
 1. 非空
 分别验证：账户、密码、校验密码、星球编号为空的场景。
 
 
 登陆有问题，在保存登陆状态的函数里 —————— 需要修改config.json里 "enable_session": true
```

